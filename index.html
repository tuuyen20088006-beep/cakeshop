<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cake Shop - Trang Chá»§</title>
  <link rel="stylesheet" href="style.css">
  <script>
    // ğŸ”’ Kiá»ƒm tra token ngay khi táº£i trang â€” trÃ¡nh nhÃ¡y ná»™i dung
    (function () {
      try {
        const token = localStorage.getItem('token');
        if (!token) window.location.replace('login.html');
      } catch (e) {
        window.location.replace('login.html');
      }
    })();
  </script>
</head>

<body>
  <!-- ğŸ§­ Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <!-- Logo -->
      <div class="nav-logo">
        <img src="https://cdn-icons-png.flaticon.com/512/857/857681.png" alt="Cake Logo" class="logo-img">
        <a href="index.html">ğŸ‚ Cake Shop</a>
      </div>

      <!-- Search -->
      <div class="nav-search">
        <input type="text" id="searchInput" placeholder="TÃ¬m kiáº¿m bÃ¡nh...">
        <button type="button" id="searchBtn">ğŸ”</button>
      </div>

      <!-- User menu -->
      <div class="nav-user">
        <div class="user-info" id="userInfo">
          <img src="" alt="Avatar" id="userAvatar" class="user-avatar">
          <span id="userName">User</span>
          <span class="dropdown-icon">â–¼</span>
        </div>

        <div class="dropdown-menu" id="dropdownMenu">
          <a href="add-cake.html" class="dropdown-item">â• ThÃªm bÃ¡nh</a>
          <a href="#" class="dropdown-item">âš™ï¸ CÃ i Ä‘áº·t</a>
          <a href="#" class="dropdown-item" id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- ğŸ‚ Ná»™i dung chÃ­nh -->
  <main class="main-content">
    <div class="cakes-header">
      <h1>Bá»™ sÆ°u táº­p bÃ¡nh cá»§a báº¡n ğŸ‚</h1>
      <div class="cakes-toolbar">
        <div id="totalInfo" class="total-info"></div>
      </div>
    </div>

    <div id="cakesStatus" class="cakes-status"></div>

    <div id="cakesGrid" class="cakes-grid" aria-live="polite"></div>

    <div class="pagination" id="pagination" aria-label="PhÃ¢n trang bÃ¡nh">
      <button id="prevPage" class="page-btn" disabled>â—€ TrÆ°á»›c</button>
      <div id="pageInfo" class="page-info">Trang 1 / 1</div>
      <button id="nextPage" class="page-btn" disabled>Tiáº¿p â–¶</button>
    </div>
  </main>

  <script>
    const API_BASE_URL = 'https://banhngot.fitlhu.com';
    let currentPage = 1, limit = 9, totalPages = 1;

    const cakesGrid = document.getElementById('cakesGrid');
    const cakesStatus = document.getElementById('cakesStatus');
    const totalInfo = document.getElementById('totalInfo');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');

    // ğŸ’¡ Äá»‹nh dáº¡ng giÃ¡ tiá»n VNÄ
    const formatVND = v => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(v);

    // ğŸ§ Hiá»ƒn thá»‹ danh sÃ¡ch bÃ¡nh
    function renderCakes(cakes) {
      if (!cakes || cakes.length === 0) {
        cakesGrid.innerHTML = '';
        cakesStatus.textContent = 'ChÆ°a cÃ³ bÃ¡nh nÃ o. HÃ£y thÃªm chiáº¿c bÃ¡nh Ä‘áº§u tiÃªn cá»§a báº¡n!';
        return;
      }
      cakesStatus.textContent = '';
      cakesGrid.innerHTML = cakes.map(c => `
        <div class="cake-card">
          <img class="cake-img" src="${c.image || 'https://via.placeholder.com/400x250?text=Cake'}" 
               alt="${c.name}" 
               onerror="this.src='https://via.placeholder.com/400x250?text=Cake'">
          <div class="cake-body">
            <h3>${c.name}</h3>
            <p class="cake-category">${c.category}</p>
            <p class="cake-price">${formatVND(c.price)}</p>
          </div>
        </div>`).join('');
    }

    // ğŸ“„ PhÃ¢n trang
    function renderPagination(pagination) {
      totalPages = pagination.totalPages || 1;
      currentPage = pagination.page || 1;
      pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
      totalInfo.textContent = `Tá»•ng sá»‘: ${pagination.total} bÃ¡nh`;
    }

    // ğŸš€ Láº¥y danh sÃ¡ch bÃ¡nh
    async function fetchCakes(page = 1) {
      const token = localStorage.getItem('token');
      if (!token) return window.location.replace('login.html');

      cakesStatus.textContent = 'Äang táº£i dá»¯ liá»‡u...';
      try {
        const res = await fetch(`${API_BASE_URL}/api/cakes/my?page=${page}&limit=${limit}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.success) {
          renderCakes(data.data);
          renderPagination(data.pagination);
        } else cakesStatus.textContent = data.message || 'KhÃ´ng thá»ƒ táº£i danh sÃ¡ch bÃ¡nh.';
      } catch (err) {
        cakesStatus.textContent = 'Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§.';
      }
    }

    // ğŸ” Sá»± kiá»‡n phÃ¢n trang
    prevPageBtn.addEventListener('click', () => currentPage > 1 && fetchCakes(currentPage - 1));
    nextPageBtn.addEventListener('click', () => currentPage < totalPages && fetchCakes(currentPage + 1));

    // ğŸ‘¤ Xá»­ lÃ½ dropdown user
    const userInfo = document.getElementById('userInfo');
    const dropdownMenu = document.getElementById('dropdownMenu');
    userInfo.addEventListener('click', e => {
      e.stopPropagation();
      dropdownMenu.classList.toggle('show');
    });
    document.addEventListener('click', () => dropdownMenu.classList.remove('show'));

    // ğŸšª ÄÄƒng xuáº¥t
    document.getElementById('logoutBtn').addEventListener('click', e => {
      e.preventDefault();
      localStorage.clear();
      window.location.href = 'login.html';
    });

    // ğŸ” TÃ¬m kiáº¿m
    document.getElementById('searchBtn').addEventListener('click', async () => {
      const q = document.getElementById('searchInput').value.trim();
      if (!q) return fetchCakes(1);
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_BASE_URL}/api/cakes/search?q=${encodeURIComponent(q)}&limit=9`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success && data.data.length > 0) {
        renderCakes(data.data);
        totalInfo.textContent = `TÃ¬m tháº¥y ${data.data.length} káº¿t quáº£`;
      } else {
        cakesGrid.innerHTML = '';
        cakesStatus.textContent = 'KhÃ´ng tÃ¬m tháº¥y bÃ¡nh nÃ o phÃ¹ há»£p.';
      }
    });

    document.getElementById('searchInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') document.getElementById('searchBtn').click();
    });

    // âš™ï¸ Load thÃ´ng tin ngÆ°á»i dÃ¹ng + bÃ¡nh khi má»Ÿ trang
    window.addEventListener('load', () => {
      const user = JSON.parse(localStorage.getItem('user'));
      if (user) {
        document.getElementById('userName').textContent = user.full_name || user.username;
        document.getElementById('userAvatar').src = user.avatar || 'https://via.placeholder.com/40';
      }
      fetchCakes(1);
    });
  </script>
</body>

</html>
